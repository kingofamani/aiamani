graph TD
    A["遊戲開始/選擇角色"] --> B{"「我是老師」"};
    A --> C{"「我是學生」"};

    B --> D["老師頁面 (teacher.html)"];
    D --> D1["顯示控制按鈕<br>(開始遊戲、喊口令、結束遊戲)"];
    D --> D2["顯示學生列表區域"];
    D --> D3["顯示老師狀態與口令區域"];
    D --> E{"「等待學生加入」"};

    C --> F["學生頁面 (student.html)"];
    F --> G["輸入暱稱"];
    G -- "點擊加入遊戲" --> H["發送 PLAYER_JOIN MQTT 訊息"];
    H --> I["顯示遊戲主界面<br>(移動按鈕、個人狀態、遊戲狀態、老師狀態與口令)"];
    I --> J{"「等待老師開始遊戲」"};

    subgraph 老師端操作
        E -- "學生 PLAYER_JOIN" --> E1["更新學生列表與狀態"];
        D1 -- "點擊 開始遊戲" --> K["發送 GAME_START MQTT<br>自動喊口令 '1' (COMMAND_UPDATE)"];
        K --> L["遊戲進行中狀態"];
        
        L -- "點擊/空白鍵 喊口令" --> M{"「口令循環」"};
        M -- "'1', '2', '3'" --> N["更新老師狀態: 背對 (安全)<br>顯示口令數字<br>發送 COMMAND_UPDATE (isSafe: true)"];
        M -- "'木頭人'" --> O["更新老師狀態: 看 (危險)<br>顯示 '木頭人'<br>發送 COMMAND_UPDATE (isSafe: false)"];
        N --> L;
        O --> L;

        D2 -- "點擊學生 抓到了按鈕" --> P["發送 PLAYER_CAUGHT MQTT"];
        P --> E1;

        L -- "學生 PLAYER_MOVE (危險時)" --> Q["判定學生犯規<br>發送 PLAYER_CAUGHT MQTT"];
        Q --> E1;
        L -- "學生 PLAYER_MOVE (安全時)" --> R["更新學生進度 (如有相關邏輯)"]; 
        R --> L;
        L -- "學生抵達終點 (PLAYER_FINISHED)" --> S["標記學生過關"];
        S --> L;
        L -- "學生 PLAYER_LEAVE" --> E1;

        D1 -- "點擊 結束遊戲" --> T["發送 GAME_END MQTT<br>重置老師口令狀態與索引<br>重置所有學生狀態"];
        T --> D1;
    end

    subgraph 學生端操作
        J -- "收到 GAME_START" --> U["進入遊戲開始狀態"];
        U -- "收到 COMMAND_UPDATE" --> V{"「判斷老師狀態」"};
        V -- "isSafe: true (口令 1,2,3)" --> W["顯示老師背對、口令數字<br>提示安全，啟用移動鈕"];
        V -- "isSafe: false (口令 木頭人)" --> X["顯示老師看、'木頭人'<br>提示危險，移動鈕仍啟用<br>但移動會被抓"];
        W --> Y{"「等待操作或新指令」"};
        X --> Y;

        Y -- "點擊 向前移動 (isSafe: true)" --> Z["發送 PLAYER_MOVE MQTT"];
        Y -- "點擊 向前移動 (isSafe: false)" --> Z; 
        Z --> Y;

        Y -- "收到 PLAYER_CAUGHT (自己)" --> AA["顯示被抓狀態<br>禁用移動"];
        Y -- "收到 PLAYER_FINISHED (自己)" --> AB["顯示過關狀態<br>禁用移動"];
        Y -- "收到 GAME_END" --> AC["遊戲結束狀態<br>重置個人狀態<br>等待新遊戲"];
        AC --> J;
        AA --> AC; 
        AB --> AC;
    end

    A ~~~ B
    B ~~~ C
    D ~~~ F
    E1 ~~~ Q
    E1 ~~~ P
    K ~~~ U
    N ~~~ W
    O ~~~ X
    T ~~~ AC


## 一二三木頭人遊戲規則與流程

**遊戲目標：**
學生在老師背對著喊口令「1、2、3」時向前移動，並在老師喊「木頭人」並轉身時保持靜止。最先安全抵達終點線的學生獲勝（或所有未被抓的學生在遊戲結束時根據進度排名）。如果在老師喊「木頭人」轉身看時被發現移動，則該學生被淘汰。

**角色：**
*   **老師 (Teacher)：** 主持遊戲，喊口令，抓犯規的學生。
*   **學生 (Student)：** 參與遊戲，根據老師的口令移動或靜止。

**詳細流程說明：**

1.  **準備階段：**
    *   使用者開啟 `index.html`，選擇扮演老師或學生。
    *   **老師：** 進入 `teacher.html`。頁面會自動嘗試連接到 MQTT 伺服器。老師界面會顯示遊戲控制按鈕（開始遊戲、喊口令、結束遊戲）、學生列表區域、以及老師自身的狀態和當前口令顯示區。
    *   **學生：** 進入 `student.html`。學生需要輸入一個暱稱，然後點擊「加入遊戲」。點擊後，學生端會連接 MQTT 並發送一個包含暱稱和客戶端ID的 `PLAYER_JOIN` 訊息。成功加入後，界面會切換到遊戲進行畫面，顯示移動按鈕、個人狀態（暱稱、頭像、是否安全）、整體遊戲狀態以及老師的狀態和口令。

2.  **遊戲開始：**
    *   老師在所有（或足夠多）學生加入後，點擊「開始遊戲」按鈕。
    *   老師端會發送 `GAME_START` 類型的 MQTT 訊息。
    *   同時，老師端的口令會自動開始循環，首先喊出「1」（並發送對應的 `COMMAND_UPDATE` 訊息）。
    *   學生端收到 `GAME_START` 訊息後，遊戲狀態更新為「遊戲開始」。

3.  **遊戲進行中：**
    *   **老師喊口令：**
        *   老師透過點擊「喊口令」按鈕或按鍵盤的空白鍵來循環口令。口令順序為：「1」->「2」->「3」->「木頭人」，然後再次從「1」開始。
        *   **當口令為「1」、「2」或「3」時（安全狀態）：**
            *   老師端的圖示顯示為背對 (🧍‍♂️🔙)，口令區域顯示對應的數字，背景呈現安全色（例如綠色）。
            *   老師端發送 `COMMAND_UPDATE` MQTT 訊息，其中 `command` 為當前數字，`isSafe` 設為 `true`。
            *   學生端收到此訊息後，會更新老師狀態顯示（老師背對、口令數字），提示學生現在是安全移動時間，並且「向前移動」按鈕應處於可用狀態（除非學生已被抓或已過關）。
        *   **當口令為「木頭人」時（危險狀態）：**
            *   老師端的圖示顯示為正在看 (👀)，口令區域顯示「木頭人」，背景呈現危險色（例如紅色）。
            *   老師端發送 `COMMAND_UPDATE` MQTT 訊息，其中 `command` 為「木頭人」，`isSafe` 設為 `false`。
            *   學生端收到此訊息後，會更新老師狀態顯示（老師在看、「木頭人」），提示學生現在是危險狀態。學生的「向前移動」按鈕在視覺上仍然是啟用的。
    *   **學生行動與判定：**
        *   **安全移動：** 當 `isSafe` 為 `true`（口令「1」、「2」、「3」）時，學生可以點擊「向前移動」按鈕。點擊後，學生端會發送 `PLAYER_MOVE` 訊息給老師。
        *   **危險時移動（嘗試）：** 當 `isSafe` 為 `false`（口令「木頭人」）時，如果學生點擊「向前移動」按鈕，學生端仍然會發送 `PLAYER_MOVE` 訊息。學生端會顯示警告，提示此行為可能導致被抓。
        *   **老師端判斷犯規：** 老師端在收到 `PLAYER_MOVE` 訊息時，會檢查當前老師是否處於 `teacherIsLooking` 狀態（即是否為「木頭人」口令）。如果是，則判定該學生犯規，並發送 `PLAYER_CAUGHT` 訊息，其中包含被抓學生的 ID 和名稱。
        *   **被抓處理：** 老師端和學生端收到 `PLAYER_CAUGHT` 訊息後，會更新對應學生的狀態，例如將其標記為被淘汰，學生端的移動按鈕會被禁用。
        *   **老師手動抓人：** 老師端界面上，每個學生的卡片旁都有一個「抓到了！」按鈕。老師可以在任何他認為學生犯規的時候點擊此按鈕，這會直接發送 `PLAYER_CAUGHT` 訊息。
        *   **抵達終點：** 當學生不斷安全移動，其進度達到預設的 `MAX_PROGRESS` 時，老師端會判定該學生成功抵達終點，並發送 `PLAYER_FINISHED` 訊息。學生端收到後，會顯示過關狀態，並禁用移動按鈕。

4.  **遊戲結束：**
    *   老師可以隨時點擊「結束遊戲」按鈕。
    *   老師端會發送 `GAME_END` 類型的 MQTT 訊息。
    *   老師端的口令顯示會恢復到初始狀態（清空口令文字，移除特殊背景色），老師圖示恢復背對，並且內部的口令循環索引 `currentCommandIndex` 會重置為 `-1`，以便下一輪從「1」開始。
    *   所有在遊戲中的學生（無論是否被抓或過關）都會被重置到「等待開始」的狀態，移動按鈕禁用，準備好開始新的一輪遊戲。

5.  **學生中途離開：**
    *   如果學生在遊戲過程中關閉瀏覽器頁面，學生端會嘗試在 `beforeunload` 事件中發送一個 `PLAYER_LEAVE` 訊息。
    *   老師端收到 `PLAYER_LEAVE` 訊息後，會將對應的學生從遊戲列表和內部數據中移除。 